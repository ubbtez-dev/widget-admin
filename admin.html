<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UBTEZ PANEL</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<style>
/* === –í–∏–∑—É–∞–ª–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π === */
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:#0e0e11;color:#fff;display:flex;justify-content:center;padding:40px 20px;}
.panel{width:920px;max-width:100%;background:linear-gradient(180deg,#3f154f 0%,#2b0f36 55%,#260c30 100%);border-radius:20px;padding:30px;box-shadow:0 12px 40px rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.06);}
h1{font-size:28px;font-weight:800;margin-bottom:25px;text-align:center;}
.section{margin-bottom:28px;padding-bottom:18px;border-bottom:1px solid rgba(255,255,255,.08);}
label{display:block;font-size:14px;font-weight:600;margin-bottom:8px;text-align:center;}
input, select{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#1a1221;color:#fff;font-size:14px;outline:none;height:42px;width:100%;}
input:focus, select:focus{border-color:#ffd76a;}
.row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:16px;}
.input-row{display:flex;width:100%;}
.button{background:linear-gradient(180deg,#ffd76a,#ffb347);border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;margin-top:10px;transition:transform .15s ease;}
.button:hover{transform:scale(1.05);}
.button-small{padding:6px 10px;font-size:12px;}
.bonus-list{margin-top:20px;}
.bonus-item{display:grid;grid-template-columns:24px 1fr 24px;gap:10px;margin-bottom:10px;border-radius:12px;padding:10px;background:rgba(255,255,255,.02);cursor:grab;}
.bonus-item.opened{opacity:.5;}
.delete-slot{cursor:pointer;font-weight:700;color:#ff4d4d;text-align:center;}
.limit-warning{text-align:center;color:#ff4d4d;font-size:13px;margin-top:10px;}
.login-panel{width:400px;background:#1a1221;padding:30px;border-radius:20px;text-align:center;}
.login-panel input{margin-bottom:15px;}
</style>
</head>
<body>

<!-- === Login Panel === -->
<div class="login-panel" id="loginPanel">
  <h2>–í–•–û–î</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button class="button" id="loginBtn">–í–•–û–î</button>
  <p id="loginError" style="color:#ff4d4d;margin-top:10px;display:none;"></p>
</div>

<!-- === Main Admin Panel === -->
<div class="panel" id="adminPanel" style="display:none;">
<h1>UBTEZ PANEL</h1>

<div class="section">
<div class="row">
<div>
<label>–ù–æ–º–µ—Ä —Å–æ–±—ã—Ç–∏—è</label>
<input type="text" id="eventNumber">
</div>
<div>
<label>–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</label>
<select id="eventType">
<option value="">‚Äî</option>
<option value="bonusbuy">BONUSBUY</option>
<option value="bonushunt">BONUSHUNT</option>
</select>
</div>
</div>
</div>

<div class="section">
<label>–û–±—â–∞—è —Å—É–º–º–∞ —Ç—Ä–∞—Ç</label>
<div class="input-row">
<input type="text" id="totalSpent">
</div>

<label style="margin-top:15px;">–û–±—â–∞—è —Å—É–º–º–∞ –≤—ã–∏–≥—Ä—ã—à–∞ (–∞–≤—Ç–æ)</label>
<div class="input-row">
<input type="text" id="totalWin" disabled>
</div>

<label style="margin-top:15px;">–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å</label>
<div class="input-row">
<input type="text" id="ratio" disabled>
</div>

<label style="margin-top:15px;">–û—Ç–∫—Ä—ã—Ç–æ / –í—Å–µ–≥–æ</label>
<div class="input-row">
<input type="text" id="bonusCount" disabled>
</div>
</div>

<div class="section">
<button class="button" id="addBonusBtn">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç</button>
<button class="button" id="clearSlotsBtn">–û—á–∏—Å—Ç–∏—Ç—å —Å–ª–æ—Ç—ã</button>

<div class="limit-warning" id="limitWarning" style="display:none;">
–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç 100 –±–æ–Ω—É—Å–æ–≤
</div>

<div class="bonus-list" id="bonusList"></div>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAvA5CAcKwuuHC2Cl8KlUbnkR9BJfp_9pw",
  authDomain:"adminwidget-b69c9.firebaseapp.com",
  databaseURL:"https://adminwidget-b69c9-default-rtdb.firebaseio.com",
  projectId:"adminwidget-b69c9"
});

const db = firebase.database();
const auth = firebase.auth();

const MAX_EVENT = 999;
const MAX_AMOUNT = 99999999;
const MAX_BONUSES = 100;

let bonuses = [];
let currentStreamer = "ubtez"; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ç–µ—Å—Ç–∞, –∑–∞–º–µ–Ω—è–µ–º –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞

// DOM elements
const loginPanel = document.getElementById("loginPanel");
const adminPanel = document.getElementById("adminPanel");
const loginError = document.getElementById("loginError");

const eventNumberEl = document.getElementById("eventNumber");
const eventTypeEl = document.getElementById("eventType");
const totalSpentEl = document.getElementById("totalSpent");
const totalWinEl = document.getElementById("totalWin");
const ratioEl = document.getElementById("ratio");
const bonusCountEl = document.getElementById("bonusCount");
const bonusListEl = document.getElementById("bonusList");
const limitWarning = document.getElementById("limitWarning");

function format(n){ return Number(n||0).toLocaleString("ru-RU"); }
function parse(v){ return parseInt(v.replace(/\s/g,""))||0; }
function restrict(el,max){
  el.addEventListener("input",e=>{
    let val = e.target.value.replace(/[^0-9]/g,"");
    if(val===""){e.target.value=""; return;}
    let num = parseInt(val);
    if(num>max) num=max;
    e.target.value = format(num);
    update();
  });
}

// ---------------- LOGIN ----------------
document.getElementById("loginBtn").onclick = () => {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  loginError.style.display = "none";

  if(!email || !password){
    loginError.textContent = "–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å";
    loginError.style.display = "block";
    return;
  }

  auth.signInWithEmailAndPassword(email,password)
    .then(userCredential=>{
      loginPanel.style.display="none";
      adminPanel.style.display="block";
      // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è —Å—Ç—Ä–∏–º–µ—Ä–∞ –ø–æ email
      currentStreamer = email.split("@")[0]; // –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –±–∞–∑–µ
      initAdmin();
    })
    .catch(err=>{
      loginError.textContent = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: "+err.message;
      loginError.style.display="block";
    });
};

// ---------------- ADMIN LOGIC ----------------
function initAdmin(){
  const ref = db.ref("events/"+currentStreamer+"/current");

  function update(){
    const totalSpent = parse(totalSpentEl.value);
    const totalWin = bonuses.reduce((s,b)=>s+(b.win||0),0);
    const opened = bonuses.filter(b=>b.opened).length;

    totalWinEl.value = format(totalWin);
    ratioEl.value = totalSpent>0 ? (totalWin/totalSpent).toFixed(2)+"x" : "";
    bonusCountEl.value = opened+" / "+bonuses.length;

    ref.set({
      eventType:eventTypeEl.value,
      eventNumber:parse(eventNumberEl.value),
      streamerName:currentStreamer,
      totalSpent,
      bonuses
    });
  }

  function render(){
    bonusListEl.innerHTML="";
    limitWarning.style.display = bonuses.length>=MAX_BONUSES ? "block" : "none";

    bonuses.forEach((b,i)=>{
      const div = document.createElement("div");
      div.className="bonus-item"+(b.opened?" opened":"");

      div.innerHTML=`
        <div style="color:#ffd76a;font-weight:700;">${i+1}</div>
        <div>
        <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${b.name||""}" ${b.opened?"disabled":""} style="width:100%;margin-bottom:6px;">
        <input type="text" placeholder="–ü–æ–∫—É–ø–∫–∞" value="${b.cost?format(b.cost):""}" ${b.opened?"disabled":""} style="width:49%;">
        <input type="text" placeholder="–í—ã–∏–≥—Ä—ã—à" value="${b.win?format(b.win):""}" ${b.opened?"disabled":""} style="width:49%;float:right;">
        <button class="button button-small" style="margin-top:6px;width:100%;">${b.opened?"–û–¢–ö–†–´–¢":"–ó–ê–ö–†–´–¢"}</button>
        </div>
        <div class="delete-slot">üóë</div>
      `;

      const inputs = div.querySelectorAll("input");
      const btn = div.querySelector("button");
      const del = div.querySelector(".delete-slot");

      restrict(inputs[1],MAX_AMOUNT);
      restrict(inputs[2],MAX_AMOUNT);

      inputs[0].oninput=e=>{b.name=e.target.value;update();}
      inputs[1].oninput=e=>{b.cost=parse(e.target.value);update();}
      inputs[2].oninput=e=>{b.win=parse(e.target.value);update();}
      btn.onclick=()=>{b.opened=!b.opened;render();}
      del.onclick=()=>{bonuses.splice(i,1);render();}

      bonusListEl.appendChild(div);
    });

    update();
  }

  restrict(eventNumberEl,MAX_EVENT);
  restrict(totalSpentEl,MAX_AMOUNT);

  document.getElementById("addBonusBtn").onclick=()=>{
    if(bonuses.length>=MAX_BONUSES) return;
    bonuses.push({name:"",cost:0,win:0,opened:false});
    render();
  };

  document.getElementById("clearSlotsBtn").onclick=()=>{
    bonuses=[];
    render();
  };

  ref.on("value",snap=>{
    const data = snap.val();
    if(!data) return;
    bonuses = data.bonuses||[];
    totalSpentEl.value = format(data.totalSpent||0);
    eventNumberEl.value = data.eventNumber||0;
    eventTypeEl.value = (data.eventType||"").toLowerCase();
    render();
  });
}
</script>

</body>
</html>
