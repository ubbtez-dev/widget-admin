<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WIDGET PANEL</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:#0e0e11;color:#fff;display:flex;justify-content:center;padding:40px 20px;}
.auth-panel{width:400px;max-width:100%;text-align:center;}
.auth-panel input{width:100%;padding:10px;margin:5px 0;border-radius:8px;border:1px solid #555;background:#1a1221;color:#fff;}
.auth-panel button{margin-top:10px;width:100%;padding:10px;border-radius:12px;background:linear-gradient(180deg,#ffd76a,#ffb347);font-weight:700;cursor:pointer;}
.auth-panel button:hover{transform:scale(1.05);}
.auth-error{color:#ff4d4d;margin-top:10px;}
.panel{width:920px;max-width:100%;background:linear-gradient(180deg,#3f154f 0%,#2b0f36 55%,#260c30 100%);border-radius:20px;padding:30px;box-shadow:0 12px 40px rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.06); display:none;}
h1{font-size:28px;font-weight:800;margin-bottom:25px;text-align:left;}
.section{margin-bottom:28px;padding-bottom:18px;border-bottom:1px solid rgba(255,255,255,.08);}
label{display:block;font-size:14px;font-weight:600;margin-bottom:8px;text-align:left;}
input, select{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#1a1221;color:#fff;font-size:14px;outline:none;height:42px;width:100%;}
input:focus, select:focus{border-color:#ffd76a;}
.row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:16px;}
.input-row{display:flex;width:100%;}
.button{background:linear-gradient(180deg,#ffd76a,#ffb347);border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;margin-top:10px;transition:transform .15s ease;}
.button:hover{transform:scale(1.05);}
.button-small{padding:6px 10px;font-size:12px;}
.bonus-list{margin-top:20px;}
.bonus-item{display:grid;grid-template-columns:24px 1fr 24px;gap:10px;margin-bottom:10px;border-radius:12px;padding:10px;background:rgba(255,255,255,.02);cursor:grab;}
.bonus-item.opened{opacity:.5;}
.delete-slot{cursor:pointer;font-weight:700;color:#ff4d4d;text-align:center;}
.limit-warning{text-align:center;color:#ff4d4d;font-size:13px;margin-top:10px;}
.bonus-item.dragging{opacity:0.5;}
</style>
</head>

<body>

<!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
<div class="auth-panel" id="authPanel">
  <h2>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</h2>
  <input type="email" id="authEmail" placeholder="Email">
  <input type="password" id="authPass" placeholder="–ü–∞—Ä–æ–ª—å">
  <button id="loginBtn">–í–æ–π—Ç–∏</button>
  <div class="auth-error" id="authError"></div>
</div>

<!-- –ü–∞–Ω–µ–ª—å –≤–∏–¥–∂–µ—Ç–∞ -->
<div class="panel" id="widgetPanel">
<h1>WIDGET PANEL</h1>

<div class="section">
<div class="row">
<div>
<label>–ù–æ–º–µ—Ä —Å–æ–±—ã—Ç–∏—è</label>
<input type="text" id="eventNumber">
</div>
<div>
<label>–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</label>
<select id="eventType">
<option value="">‚Äî</option>
<option value="bonusbuy">BONUSBUY</option>
<option value="bonushunt">BONUSHUNT</option>
</select>
</div>
</div>
</div>

<div class="section">
<label>–û–±—â–∏–π –¥–µ–ø–æ–∑–∏—Ç –Ω–∞ —Å–æ–±—ã—Ç–∏–µ (–≤–≤–µ–¥–∏)</label>
<div class="input-row">
<input type="text" id="totalSpent">
</div>

<label style="margin-top:15px;">–û–±—â–∏–π –≤—ã–∏–≥—Ä—ã—à —Å —Å–æ–±—ã—Ç–∏—è (–∞–≤—Ç–æ)</label>
<div class="input-row">
<input type="text" id="totalWin" disabled>
</div>

<label style="margin-top:15px;">–ú–Ω–æ–∂–∏—Ç–µ–ª—å –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ —Å–æ–±—ã—Ç–∏—è (–∞–≤—Ç–æ)</label>
<div class="input-row">
<input type="text" id="ratio" disabled>
</div>

<label style="margin-top:15px;">–û—Ç–∫—Ä—ã—Ç—ã–µ –∏ –∑–∞–∫—Ä—ã—Ç—ã–µ –±–æ–Ω—É—Å—ã (–∞–≤—Ç–æ)</label>
<div class="input-row">
<input type="text" id="bonusCount" disabled>
</div>
</div>

<div class="section">
<button class="button" id="addBonusBtn">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç</button>
<button class="button" id="clearSlotsBtn">–û—á–∏—Å—Ç–∏—Ç—å —Å–ª–æ—Ç—ã</button>

<div class="limit-warning" id="limitWarning" style="display:none;">
–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç 100 –±–æ–Ω—É—Å–æ–≤
</div>

<div class="bonus-list" id="bonusList"></div>
</div>
</div>

<script>
firebase.initializeApp({
apiKey:"AIzaSyAvA5CAcKwuuHC2Cl8KlUbnkR9BJfp_9pw",
databaseURL:"https://adminwidget-b69c9-default-rtdb.firebaseio.com"
});

const db = firebase.database();
const auth = firebase.auth();

const MAX_EVENT = 999;
const MAX_AMOUNT = 99999999;
const MAX_BONUSES = 100;

let bonuses = [];
let streamerKey = null; // –ø—É—Ç—å –∫ events/<streamer>

const authPanel = document.getElementById("authPanel");
const authEmail = document.getElementById("authEmail");
const authPass = document.getElementById("authPass");
const loginBtn = document.getElementById("loginBtn");
const authError = document.getElementById("authError");
const widgetPanel = document.getElementById("widgetPanel");

const eventNumberEl = document.getElementById("eventNumber");
const eventTypeEl = document.getElementById("eventType");
const totalSpentEl = document.getElementById("totalSpent");
const totalWinEl = document.getElementById("totalWin");
const ratioEl = document.getElementById("ratio");
const bonusCountEl = document.getElementById("bonusCount");
const bonusListEl = document.getElementById("bonusList");
const limitWarning = document.getElementById("limitWarning");

// === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
function format(n){return Number(n||0).toLocaleString("ru-RU");}
function parse(v){return parseInt(v.replace(/\s/g,""))||0;}
function restrict(el,max){
  el.addEventListener("input",e=>{
    let val = e.target.value.replace(/[^0-9]/g,"");
    if(val===""){e.target.value=""; return;}
    let num = parseInt(val);
    if(num>max) num=max;
    e.target.value = format(num);
    update();
  });
}

// === –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ===
loginBtn.onclick = () => {
  authError.textContent = "";
  auth.signInWithEmailAndPassword(authEmail.value, authPass.value)
  .then(userCredential => {
    const user = userCredential.user;
    // –Ω–∞—Ö–æ–¥–∏–º –∫–ª—é—á —Å—Ç—Ä–∏–º–µ—Ä–∞ –ø–æ email
    db.ref('streamers').once('value').then(snapshot=>{
      const data = snapshot.val();
      for(const key in data){
        if(data[key] === user.email){
          streamerKey = key;
          break;
        }
      }
      if(!streamerKey){
        auth.signOut();
        authError.textContent = "–í–∞—à email –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ —Å—Ç—Ä–∏–º–µ—Ä–æ–≤";
        return;
      }
      authPanel.style.display = "none";
      widgetPanel.style.display = "block";
      render();
    });
  })
  .catch(err=>{
    authError.textContent = err.message;
  });
};

// === –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ===
auth.onAuthStateChanged(user=>{
  if(user){
    db.ref('streamers').once('value').then(snapshot=>{
      const data = snapshot.val();
      for(const key in data){
        if(data[key] === user.email){
          streamerKey = key;
          break;
        }
      }
      if(streamerKey){
        authPanel.style.display = "none";
        widgetPanel.style.display = "block";
        render();
      } else {
        auth.signOut();
      }
    });
  }
});

// === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ Firebase ===
function update(){
  if(!streamerKey) return;
  const totalSpent = parse(totalSpentEl.value);
  const totalWin = bonuses.reduce((s,b)=>s+(b.win||0),0);
  const opened = bonuses.filter(b=>b.opened).length;

  totalWinEl.value = format(totalWin);
  ratioEl.value = totalSpent>0 ? (totalWin/totalSpent).toFixed(2)+"x" : "";
  bonusCountEl.value = opened+" / "+bonuses.length;

  db.ref("events/"+streamerKey+"/current").set({
    eventType:eventTypeEl.value,
    eventNumber:parse(eventNumberEl.value),
    streamerName:streamerKey,
    totalSpent,
    bonuses
  });
}

// === –†–µ–Ω–¥–µ—Ä –±–æ–Ω—É—Å–æ–≤ ===
function render(){
  if(!streamerKey) return;
  bonusListEl.innerHTML="";
  limitWarning.style.display = bonuses.length>=MAX_BONUSES ? "block" : "none";

  bonuses.forEach((b,i)=>{
    const div = document.createElement("div");
    div.className="bonus-item"+(b.opened?" opened":"");
    div.setAttribute("draggable","true");
    div.dataset.index = i;
    div.innerHTML=`
<div style="color:#ffd76a;font-weight:700;">${i+1}</div>
<div>
<input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${b.name||""}" ${b.opened?"disabled":""} style="width:100%;margin-bottom:6px;">
<input type="text" placeholder="–ü–æ–∫—É–ø–∫–∞" value="${b.cost?format(b.cost):""}" ${b.opened?"disabled":""} style="width:49%;">
<input type="text" placeholder="–í—ã–∏–≥—Ä—ã—à" value="${b.win?format(b.win):""}" ${b.opened?"disabled":""} style="width:49%;float:right;">
<button class="button button-small" style="margin-top:6px;width:100%;">${b.opened?"–û–¢–ö–†–´–¢":"–ó–ê–ö–†–´–¢"}</button>
</div>
<div class="delete-slot">üóë</div>
`;
    const inputs = div.querySelectorAll("input");
    const btn = div.querySelector("button");
    const del = div.querySelector(".delete-slot");

    restrict(inputs[1],MAX_AMOUNT);
    restrict(inputs[2],MAX_AMOUNT);

    inputs[0].oninput=e=>{b.name=e.target.value;update();}
    inputs[1].oninput=e=>{b.cost=parse(e.target.value);update();}
    inputs[2].oninput=e=>{b.win=parse(e.target.value);update();}

    btn.onclick=()=>{b.opened=!b.opened;render(); update();}
    del.onclick=()=>{bonuses.splice(i,1);render(); update();}

    bonusListEl.appendChild(div);
  });

  // Drag & Drop
  let dragSrcEl = null;
  const items = document.querySelectorAll('.bonus-item');
  items.forEach(item=>{
    item.addEventListener('dragstart', e=>{
      dragSrcEl = item;
      item.classList.add('dragging');
    });
    item.addEventListener('dragend', e=>{
      item.classList.remove('dragging');
    });
    item.addEventListener('dragover', e=>{
      e.preventDefault();
      const target = e.currentTarget;
      if(target===dragSrcEl) return;
      const srcIndex = parseInt(dragSrcEl.dataset.index);
      const tgtIndex = parseInt(target.dataset.index);
      bonuses.splice(tgtIndex,0,bonuses.splice(srcIndex,1)[0]);
      render();
    });
  });

  update();
}

// === –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤–≤–æ–¥–∏–º—ã—Ö —á–∏—Å–µ–ª ===
restrict(eventNumberEl,MAX_EVENT);
restrict(totalSpentEl,MAX_AMOUNT);

// === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ / –æ—á–∏—Å—Ç–∫–∞ –±–æ–Ω—É—Å–æ–≤ ===
document.getElementById("addBonusBtn").onclick=()=>{
  if(bonuses.length>=MAX_BONUSES) return;
  bonuses.push({name:"",cost:0,win:0,opened:false});
  render();
};

document.getElementById("clearSlotsBtn").onclick=()=>{
  bonuses=[];
  render();
};

</script>

</body>
</html>
