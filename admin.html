<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADMIN PANEL</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:#0e0e11;color:#fff;display:flex;justify-content:center;padding:40px 20px;}
.panel{width:920px;max-width:100%;background:linear-gradient(180deg,#3f154f 0%,#2b0f36 55%,#260c30 100%);border-radius:20px;padding:30px;box-shadow:0 12px 40px rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.06);}
h1{font-size:28px;font-weight:800;margin-bottom:25px;letter-spacing:1px;text-align:center;}
.section{margin-bottom:28px;padding-bottom:18px;border-bottom:1px solid rgba(255,255,255,.08);}
label{display:block;font-size:14px;font-weight:600;margin-bottom:8px;opacity:.9;text-align:center;}

input, select{
padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.1);
background:#1a1221;color:#fff;font-size:14px;outline:none;height:42px;width:100%;
}

input:focus, select:focus{border-color:#ffd76a;}

.row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;align-items:end;margin-bottom:16px;}
.input-row{display:flex;align-items:center;gap:6px;width:100%;margin:0 auto;}

.button{background:linear-gradient(180deg,#ffd76a,#ffb347);border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;margin-top:10px;transition:transform 0.15s ease;}
.button:hover{transform:scale(1.05);}
.button-small{padding:6px 10px;font-size:12px;white-space:nowrap;}

.bonus-list{margin-top:20px;}
.bonus-item{display:grid;grid-template-columns:24px 1fr 24px;align-items:center;gap:10px;margin-bottom:10px;border-radius:12px;padding:10px;background: rgba(255,255,255,0.02);transition: all 0.2s ease;cursor: grab;}
.bonus-item.dragging{opacity:0.5;}
.bonus-item.opened{opacity:0.5;}

.flex-row{display:flex;justify-content:space-between;align-items:center;gap:10px;}
.bonus-inputs{display:flex;gap:8px;margin-top:8px;}
.bonus-inputs input{flex:1;}
.delete-slot{cursor:pointer;font-weight:700;color:#ff4d4d;text-align:center;}

@media(max-width:600px){
.row{grid-template-columns:1fr;}
.bonus-item{grid-template-columns:auto 1fr auto;}
.input-row{width:100%;}
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>

<div class="panel">
<h1>ADMIN PANEL</h1>

<div class="section">
<div class="row">
<div>
<label>–ù–æ–º–µ—Ä —Å–æ–±—ã—Ç–∏—è</label>
<input type="text" id="eventNumber" placeholder="‚Äî" />
</div>
<div>
<label>–í—ã–±–æ—Ä —Å–æ–±—ã—Ç–∏—è</label>
<select id="eventType">
<option value="">‚Äî</option>
<option value="bonusbuy">BONUSBUY</option>
<option value="bonushunt">BONUSHUNT</option>
</select>
</div>
<div>
<label>–í–∞–ª—é—Ç–∞ —Å–æ–±—ã—Ç–∏—è</label>
<select id="eventCurrency">
<option value="">‚Äî</option>
<option value="RUB">‚ÇΩ</option>
<option value="USD">$</option>
</select>
</div>
</div>
</div>

<div class="section">
<label>–û–±—â–∞—è —Å—É–º–º–∞ —Ç—Ä–∞—Ç (–≤–µ—Å—å –±–∞–ª–∞–Ω—Å)</label>
<div class="input-row">
<input type="text" id="totalSpent" placeholder="0"/>
</div>

<label style="margin-top:16px;">–û–±—â–∞—è —Å—É–º–º–∞ –≤—ã–∏–≥—Ä—ã—à–∞ (–∞–≤—Ç–æ)</label>
<div class="input-row">
<input type="text" id="totalWin" disabled/>
</div>

<label style="margin-top:16px;">–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ (–∞–≤—Ç–æ)</label>
<div class="input-row">
<input type="text" id="ratio" disabled/>
</div>

<label style="margin-top:16px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ–Ω—É—Å–æ–≤ (–æ—Ç–∫—Ä—ã—Ç–æ / –≤—Å–µ–≥–æ)</label>
<div class="input-row">
<input type="text" id="bonusCount" disabled/>
</div>
</div>

<div class="section">
<div class="flex-row">
<button class="button" id="addBonusBtn">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç</button>
<button class="button" id="clearSlotsBtn">–°—Ç–µ—Ä–µ—Ç—å —Å–ª–æ—Ç—ã</button>
</div>
<div class="bonus-list" id="bonusList"></div>
</div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAvA5CAcKwuuHC2Cl8KlUbnkR9BJfp_9pw",
  authDomain: "adminwidget-b69c9.firebaseapp.com",
  projectId: "adminwidget-b69c9",
  storageBucket: "adminwidget-b69c9.firebasestorage.app",
  messagingSenderId: "585800098669",
  appId: "1:585800098669:web:f7e7ebf11cce37b0e73064",
  databaseURL: "https://adminwidget-b69c9-default-rtdb.firebaseio.com"
});
const db = firebase.database();

let bonuses = [];

const MAX_EVENT = 999;
const MAX_AMOUNT = 99999999;

const eventNumberEl = document.getElementById('eventNumber');
const totalSpentEl = document.getElementById('totalSpent');
const totalWinEl = document.getElementById('totalWin');
const ratioEl = document.getElementById('ratio');
const bonusCountEl = document.getElementById('bonusCount');
const bonusListEl = document.getElementById('bonusList');
const addBonusBtn = document.getElementById('addBonusBtn');
const clearSlotsBtn = document.getElementById('clearSlotsBtn');

function formatNumber(num){return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g," ");}

function parseNumber(value){return parseInt(value.replace(/\s/g,''))||0;}

function restrictAndFormat(el,max){
  el.addEventListener('input', e=>{
    let value = e.target.value.replace(/[^0-9]/g,'');
    if(value===''){e.target.value=''; return;}
    let num = parseInt(value);
    if(num>max) num = max;
    e.target.value = formatNumber(num);
    updateStats();
  });
}

function updateStats(){
  const totalSpentVal = parseNumber(totalSpentEl.value);
  const totalWinVal = bonuses.reduce((sum,b)=>sum+(b.win||0),0);
  const openedCount = bonuses.filter(b=>b.opened).length;

  totalWinEl.value = formatNumber(totalWinVal);
  ratioEl.value = totalSpentVal>0?(totalWinVal/totalSpentVal).toFixed(2)+'x':'';
  bonusCountEl.value = openedCount+' / '+bonuses.length;

  const eventType = document.getElementById('eventType').value;
  const eventNumber = parseNumber(eventNumberEl.value);
  const eventCurrency = document.getElementById('eventCurrency').value;

  if(eventType && eventNumber && eventCurrency){
    db.ref('events/ubtez_current').set({
      eventType,
      eventNumber,
      currency: eventCurrency,
      streamerName: 'ubtez',
      totalSpent: totalSpentVal,
      totalWin: totalWinVal,
      bonuses
    });
  }
}

function render(){
  bonusListEl.innerHTML='';
  bonuses.forEach((b,i)=>{
    const wrapper = document.createElement('div');
    wrapper.className='bonus-item';
    wrapper.draggable=true;
    if(b.opened) wrapper.classList.add('opened');

    wrapper.innerHTML = `
      <div style="text-align:center;font-weight:700;color:#ffd76a;">${i+1}</div>
      <div style="display:flex;flex-direction:column;">
        <div class="bonus-inputs">
          <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–æ—Ç–∞" value="${b.name||''}" ${b.opened?'disabled':''}/>
        </div>
        <div class="bonus-inputs">
          <input type="text" placeholder="–°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏" value="${b.cost?formatNumber(b.cost):''}" ${b.opened?'disabled':''}/>
          <input type="text" placeholder="–°—É–º–º–∞ –≤—ã–∏–≥—Ä—ã—à–∞" value="${b.win?formatNumber(b.win):''}" ${b.opened?'disabled':''}/>
        </div>
        <button class="button button-small" style="margin-top:8px;">${b.opened?'–û–¢–ö–†–´–¢':'–ó–ê–ö–†–´–¢'}</button>
      </div>
      <div class="delete-slot">üóë</div>
    `;

    const inputs = wrapper.querySelectorAll('input');
    const openBtn = wrapper.querySelector('button');
    const deleteBtn = wrapper.querySelector('.delete-slot');

    restrictAndFormat(inputs[1], MAX_AMOUNT);
    restrictAndFormat(inputs[2], MAX_AMOUNT);

    inputs[0].addEventListener('input', e=>{b.name=e.target.value; updateStats();});
    inputs[1].addEventListener('input', e=>{b.cost=parseNumber(e.target.value); updateStats();});
    inputs[2].addEventListener('input', e=>{b.win=parseNumber(e.target.value); updateStats();});

    openBtn.addEventListener('click', ()=>{b.opened=!b.opened; render();});
    deleteBtn.addEventListener('click', ()=>{bonuses.splice(i,1); render();});

    wrapper.addEventListener('dragstart', e=>{e.dataTransfer.setData('text/plain',i); wrapper.classList.add('dragging');});
    wrapper.addEventListener('dragend', ()=>wrapper.classList.remove('dragging'));
    wrapper.addEventListener('dragover', e=>e.preventDefault());
    wrapper.addEventListener('drop', e=>{
      e.preventDefault();
      const dragged = Number(e.dataTransfer.getData('text/plain'));
      if(dragged===i) return;
      [bonuses[dragged], bonuses[i]] = [bonuses[i], bonuses[dragged]];
      render();
    });

    bonusListEl.appendChild(wrapper);
  });
  updateStats();
}

restrictAndFormat(eventNumberEl, MAX_EVENT);
restrictAndFormat(totalSpentEl, MAX_AMOUNT);

addBonusBtn.addEventListener('click', ()=>{bonuses.push({name:'',cost:0,win:0,opened:false}); render();});
clearSlotsBtn.addEventListener('click', ()=>{bonuses=[]; render();});

render();
</script>
</body>
</html>
