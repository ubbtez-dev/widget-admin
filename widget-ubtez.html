<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WIDGET</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  height:100vh;
  background:#00ff00;
  display:flex;
  justify-content:center;
  align-items:center;
  font-family:'Inter',sans-serif;
}
.widget{
  width:520px;
  border-radius:22px;
  padding:26px;
  color:#fff;
  border:1px solid rgba(255,255,255,.08);
  transition: background 0.5s ease;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:18px;
}
.left-header{
  display:flex;
  align-items:center;
  gap:12px;
}
.right-header{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:24px;
  font-weight:800;
}
.emoji{ font-size:32px; }
.title{ font-size:24px; font-weight:800; }
.stats{
  display:flex;
  justify-content:space-between;
  text-align:center;
  font-size:21px;
  font-weight:700;
}
.divider{
  height:1px;
  background:rgba(255,255,255,.15);
  margin:16px 0;
}
.biggest{
  background:rgba(255,215,106,.10);
  padding:16px;
  border-radius:12px;
  font-size:21px;
  font-weight:800;
  color:#ffd76a;
}
.list{
  overflow:hidden;
  transition:opacity .5s ease;
}
.item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  height:43px;
  font-size:21px;
  font-weight:600;
  border-bottom:1px solid rgba(255,255,255,.06);
}
.current{
  color:#ffd76a;
  font-weight:900;
}
.footer-text{
  margin-top:18px;
  text-align:center;
  font-size:16px;
  opacity:.7;
  letter-spacing:1px;
  font-weight:600;
}
</style>
</head>

<body>

<div class="widget" id="widget">
  <div class="header">
    <div class="left-header">
      <div class="emoji" id="emoji">üé∞</div>
      <div class="title" id="title">BONUSBUY #0</div>
    </div>
    <div class="right-header" id="streamerName">
      UBTEZ <span>üÉè</span>
    </div>
  </div>

  <div class="divider"></div>

  <div class="stats">
    <div>üí∞ <span id="spent">0</span></div>
    <div>‚ùå <span id="ratio">0x</span></div>
    <div>‚≠ê <span id="count">0/0</span></div>
  </div>

  <div class="divider"></div>

  <div class="biggest" id="biggest">üèÜ ‚Äî</div>

  <div class="divider"></div>

  <div class="list" id="list"></div>

  <div class="footer-text">
    –≠–¢–û - –¢–í–û–ô –ë–£–î–£–©–ò–ô –í–ò–î–ñ–ï–¢!
  </div>
</div>

<script>

// FIREBASE INIT
firebase.initializeApp({
  apiKey:"AIzaSyAvA5CAcKwuuHC2Cl8KlUbnkR9BJfp_9pw",
  authDomain:"adminwidget-b69c9.firebaseapp.com",
  databaseURL:"https://adminwidget-b69c9-default-rtdb.firebaseio.com",
  projectId:"adminwidget-b69c9"
});
const db = firebase.database();

// URL
const params = new URLSearchParams(window.location.search);
const streamer = (params.get("streamer") || "ubtez").toLowerCase();
let mode = (params.get("mode") || "horizontal").toLowerCase();

// –∑–∞—â–∏—Ç–∞ –æ—Ç –∫—Ä–∏–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
if(mode !== "vertical") mode = "horizontal";

document.getElementById("streamerName").innerHTML =
  streamer.toUpperCase()+" <span>üÉè</span>";

const widgetEl = document.getElementById("widget");
const listEl = document.getElementById("list");

// —Å—Ç–∏–ª–∏ —Ä–µ–∂–∏–º–∞
const perPage = mode==="vertical"?5:10;
listEl.style.height = mode==="vertical"?"215px":"430px";
widgetEl.style.background = mode==="vertical"
  ?"linear-gradient(180deg,#013220 0%,#026644 60%,#014d36 100%)"
  :"linear-gradient(180deg,#3f154f 0%,#2b0f36 60%,#260c30 100%)";

// –≤–∞–ª—é—Ç—ã
const currencyMap = {
  RUB:"‚ÇΩ", USD:"$", EUR:"‚Ç¨", KZT:"‚Ç∏",
  UAH:"‚Ç¥", BYN:"Br", USDT:" USDT", BTC:" BTC"
};

let currencySymbol="";
let currentPage=0;
let interval=null;

function format(n){ return Number(n||0).toLocaleString("ru-RU"); }
function limitName(n){ return !n?"":n.length<=25?n:n.substring(0,22)+"..."; }
function money(n){ return currencySymbol?format(n)+currencySymbol:format(n); }

function render(data){

  const bonuses=data.bonuses||[];
  const totalSpent=data.totalSpent||0;
  const totalWin=bonuses.reduce((s,b)=>s+(b.win||0),0);
  const opened=bonuses.filter(b=>b.opened).length;
  const total=bonuses.length;

  document.getElementById("spent").textContent=money(totalSpent);
  document.getElementById("ratio").textContent=
    totalSpent>0?(totalWin/totalSpent).toFixed(2)+"x":"0x";
  document.getElementById("count").textContent=opened+"/"+total;

  const maxBonus=bonuses.reduce((m,b)=>
    (b.win||0)>(m.win||0)?b:m ,{win:0});

  document.getElementById("biggest").innerHTML=
    maxBonus.win>0
      ?`üèÜ ${money(maxBonus.win)} ‚Äî ${limitName(maxBonus.name)} (${money(maxBonus.cost)})`
      :"üèÜ ‚Äî";

  const totalPages=Math.ceil(total/perPage);
  const nextIndex=bonuses.findIndex(b=>!b.opened);

  if(opened!==total){
    if(interval){clearInterval(interval);interval=null;}
    if(nextIndex>=0) currentPage=Math.floor(nextIndex/perPage);
  }

  listEl.innerHTML="";
  const start=currentPage*perPage;
  bonuses.slice(start,start+perPage).forEach((b,i)=>{
    const div=document.createElement("div");
    const globalIndex=start+i;
    div.className="item"+(globalIndex===nextIndex?" current":"");
    div.innerHTML=`
      <span>${globalIndex+1}. ${limitName(b.name)} (${money(b.cost)})</span>
      <span>${b.opened?money(b.win):"-"}</span>
    `;
    listEl.appendChild(div);
  });

  if(opened===total && totalPages>1 && !interval){
    interval=setInterval(()=>{
      currentPage++;
      if(currentPage>=totalPages) currentPage=0;
      render(data);
    },6000);
  }
}

// SUBSCRIBE
db.ref(`events/${mode}/${streamer}/current`)
.on("value",snap=>{
  const data=snap.val();
  if(!data) return;

  currencySymbol = currencyMap[data.widgetCurrency] || "";

  const type=(data.eventType||"bonusbuy").toLowerCase();
  document.getElementById("emoji").textContent =
    type==="bonushunt"?"üçÄ":"üé∞";

  document.getElementById("title").textContent =
    type.toUpperCase()+" #"+(data.eventNumber||0);

  render(data);
});

</script>
</body>
</html>
